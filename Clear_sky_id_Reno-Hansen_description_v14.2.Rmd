---
title:     Identification of Periods of Clear Sky Irradiance in Time Series of GHI Measurements Matthew J. Reno and Clifford W. Hansen.
author:    Natsis Athanasios
documentclass: article
classoption:   a4paper,oneside
fontsize:      10pt
geometry:      "left=0.5in,right=0.5in,top=0.5in,bottom=0.5in"

link-citations:  yes
colorlinks:      yes

header-includes:
  - \usepackage{caption}
  - \usepackage{placeins}
  - \captionsetup{font=small}
  - \usepackage{multicol}
  - \setlength{\columnsep}{1cm}

output:
  bookdown::pdf_document2:
    number_sections:  yes
    fig_caption:      no
    keep_tex:         no
    toc_depth:        4
    latex_engine:     xelatex
    toc:              yes
    fig_width:        7
    fig_height:       4.5
---

```{r setup, echo=F, include=T, eval=TRUE}
MS <- data.frame(readRDS("PARAMS/Clear_sky_id_Reno-Hansen_apply_v14_2.Rds"))
# export all variables
for (an in names(MS)) {
    assign(an, MS[[an]])
}
```



<!-- `````{r echo=F, include=F, eval=F} -->
<!-- knitr::opts_chunk$set(comment    = ""      ) -->
<!-- # knitr::opts_chunk$set(dev        = "pdf"   ) -->
<!-- knitr::opts_chunk$set(dev        = "png"    ) -->
<!-- knitr::opts_chunk$set(out.width  = "100%"   ) -->
<!-- knitr::opts_chunk$set(fig.align  = "center" ) -->
<!-- # knitr::opts_chunk$set(fig.pos    = '!h'    ) -->


<!-- #  Use the optimized alpha for the selected models and identify Clear-Sky -->
<!-- #  minutes. -->

<!-- ## load previous state have to override it for alpha to be used -->
<!-- load("~/Aerosols/DATA/model_opt/Combinations_results_2022-06-14_153313.Rds") -->


<!-- ## Define the model to use for CS detection be inspecting the results of the 'a' optimization script. -->
<!-- model_selection <- "HAU" -->
<!-- monthly_alphas  <- gather_results[gather_results$CS_models == model_selection,] -->

<!-- ## daily plots file name -->
<!-- plotsbase <- paste0("~/CS_id/REPORTS/DAILY/", -->
<!--                     sub("\\.R$", "", basename(Script.Name)), "_") -->
<!-- ````` -->





\newpage

# Detection of clear periods in GHI measurements for SDR tredns.


## Only filters for GHI are used for SDR tredns

## Load all data from `DATA/Broad_Band/QCRad_LongShi/QCRad_LongShi_v8_apply_CM21_CHP1_[0-9]{4}.Rds`

##  Exclude data where `wattGLB < wattHOR`

There are instances where global irradiance is less than direct.

This happens, near sunset and sunrise due to obstacles,
or due to different sunrise/sunset time due to small spatial differences.
We will exclude all this data both for global and direct.


##  Exclude other bad data indentified in raw data

<!-- strong[QCF_DIR == FALSE, wattDIR     := NA] -->
<!-- strong[QCF_DIR == FALSE, wattHOR     := NA] -->
<!-- strong[QCF_DIR == FALSE, wattDIR_sds := NA] -->
<!-- strong[QCF_DIR == FALSE, wattDIF     := NA] -->
<!-- strong[QCF_GLB == FALSE, wattGLB     := NA] -->
<!-- strong[QCF_GLB == FALSE, wattGLB_sds := NA] -->
<!-- strong[QCF_GLB == FALSE, wattDIF     := NA] -->




### Threshold Values for Criteria

For mean and max Most evaluations of clear sky models find that the average
bias error of the model is less than 10%, often around 7% [1, 83]. Therefore,
a fixed threshold of $\pm 75 W / m^2$ within the mean and max of the clear sky model
was chosen.



### Clear Sky detection Algorithm values


<!-- `````{r include=F, eval=F, echo=F} -->
<!-- # panderOptions('table.emphasize.rownames', F) -->
<!-- panderOptions('table.alignment.default',  "right") -->
<!-- panderOptions('table.alignment.rownames', "right") -->
<!-- panderOptions('table.split.cells',        c(50,10)) -->
<!-- ````` -->




### Reference clear sky irradiance model and air mass model (AM)

We select the clear sky model, the air mass calculation
and the period of $`r nt`$ minutes to use.
The characterization is done to the center value of the window.


`````{r include=F, eval=F, echo=F}
AM       <- AM_simple
CS_model <- get(model_selection)
`````


`````{r include=F, eval=T, echo=F}
MS <- data.frame()
`````

Air mass model

$$ AM = \frac{1}{\cos(z)} $$

### Clear Sky irradiance Haurwitz model (HAU) (1945)  

\begin{equation}
\text{GHI}_\text{Clear Sky} = `r signif(alpha,3)` \times 1098 \times \cos( \text{SZA} ) \times \exp \left( \frac{ - 0.057}{\cos(\text{SZA})} \right)  (\#eq:ahau)
\end{equation}


## Clear sky Id procedure

<!-- FDP -->
### 9. Too Few data points for the day

Days with less than $`r nt * 3`$ data points (minutes) will be ignored.



<!-- MeanVIP -->
### 1. Mean value of irradiance during the time period 

Comparing value in a moving window of $`r nt`$ minutes.
The mean of the measured value $\overline{G}_i$ inside an envelope based on the reference model $\text{GHI}_\text{Clear Sky}$.

\begin{equation}
`r 1 - CS_ref_rm_VIP_RelLow` \times \overline{\text{GHI}}_{i\text{Clear Sky}} - `r CS_ref_rm_VIP_LowOff`
< \overline{G}_i <
`r 1 + CS_ref_rm_VIP_RelUpp` \times \overline{\text{GHI}}_{i\text{Clear Sky}} + `r CS_ref_rm_VIP_UppOff`
(\#eq:MeanVIP)
\end{equation}


<!-- MaxVIP -->
### 2. Max value of irradiance during the time period

The running max measured value $M_{Gi} = max[\text{GHI}_{i}]$ is compared to a similar constructed value from the reference $M_{CSi} = max[\text{GHI}_{i\text{Clear Sky}}]$.

\begin{equation}
`r MaxVIP_fct` \times M_{CSi} - `r MaxVIP_off_low`
< M_{Gi} <
`r MaxVIP_fct` \times M_{CSi} + `r MaxVIP_off_upp`
(\#eq:MaxVIP)
\end{equation}


<!-- VIL -->
###  3. Variability in irradiance by line length

 The length L of the sequence of line segments connecting the points of the GHI time
series is calculated by 

\begin{equation}
L = \sum_{i=1}^{n-1}\sqrt{\left ( \text{GHI}_{i+1} - \text{GHI}_{i}\right )^2 + \left ( t_{i+1} - t_i \right )^2}
(\#eq:VILeq)
\end{equation}

for the measured values $L$ and similar $L_{CS}$ using the reference model $\text{GHI}_{i\text{Clear Sky}}$. The criterion is applied

\begin{equation}
`r MinVIL_fct` \times L_{CSi} - `r offVIL_dwl` < L_i < `r MaxVIL_fct` \times L_{CSi} + `r offVIL_upl`
(\#eq:VILcr)
\end{equation}


<!-- VCT -->
### 4. Variance of Changes in the Time series

Standard deviation of rate of change in irradiance. We calculate the standard deviation ÔÅ≥ of the slope
(s) between sequential points in the time series, normalized by the average GHI during the time interval:


\begin{gather}
s_i = \frac{\text{GHI}_{i+1} - \text{GHI}_{i}}{t_{i+1} - t_i}, \forall i \in \left \{ 1, 2, \ldots, n-1 \right \} (\#eq:VCT1)
\bar{s} = \frac{1}{n-1} \sum_{i=1}^{n-1} s_i (\#eq:VCT2)
\end{gather}


### 6. Low Direct Irradiance limit (LDI)

Ignore Direct irradiance when it is bellow $5 Watt/m^2$.
This limit is biased due to the slight location difference of the two Instruments.
The difference in shadow especially the afternoon "pole shadow" of some periods of the year.
May limit the implementation by time of day or/and period of the year

Also this can not characterize all global measurements due to gaps on direct measurements.


`````{r include=F, eval=F, echo=F}
#### 7. LGI ####
MS$VGIlim <- 5
`````


### 7. Low Global Irradiance limit (LGI)

<!-- Global irradiance below `r MS$VGIlim` 5 $Watt/m^2$ level can not be identified -->




### 8. Too Few CS point for the day (FCS)


If in a day there less than 11 clear sky points will exclude them from optimizing




### 9. Too Few data points for the day (FDP)


If in a day there are less than 33 data points will be excluded from optimizing.




### 11. Too low Direct signal (DsT)

This is a simple hard limit on the lower possible Direct radiation with clear sky.

The threshold is 25% lower than a reference value.

$$ I_d = I_0 * 0.7^{{AM}^{0.678}} * cos({ZSA}) $$

Where ${AM}$ is the selected air-mass model.

"Clear sky direct normal irradiance estimation based on adjustable inputs and error correction_Zhu2019.pdf"






### Baseline value for direct irradiance

See: Clear sky direct normal irradiance estimation based on adjustable inputs and error correction_Zhu2019.pdf

`````{r include=F, eval=F}
strong[ , CS_ref_HOR := ( TSIextEARTH_comb * 0.7 ^ AM(SZA) ^ 0.678 ) * cosde(SZA) ]
`````

`````{r include=F, eval=F, echo=F}
##  Iterate all years
for (yyyy in unique(year(dayslist))) {

    ##  Iterate all days
    for (aa in subdayslist) {

        nt_hw <- MS$nt %/% 2

        ## relative clear sky acceptance limit
        relative_CS_lim <- sum(sell) * MS$relative_CS

        ## Data selection for day
        subday     <- strong[ sell, ]
        have_glb   <- !is.na(subday$wattGLB)  ## use vectors!
        have_dir   <- !is.na(subday$wattDIR)  ## use vectors!
        tot_p      <- length(subday$wattGLB)


        ## Values from Clear sky model used
        ## this model is used as clear sky reference
        CS_ref <- CS_model(subday$SZA) * alpha
        ## Values from Air Mass model used
        AM_ref <- AM(subday$SZA)

        ## create a more logical model
        CS_ref_safe <- CS_ref
        CS_ref_safe[ CS_ref_safe < 0 ] <- NA


        #### Apply filters ####

        #---- 9. Too Few data point for the day (FDP) --------------------------
        #---- 1. Mean value of irradiance during the time period ---------------
        #---- 2. Max value of irradiance during the time period ----------------
        #---- 3. Variability in irradiance by the length (VIL) -----------------
 
        #---- 4. Variance of Changes in the Time series (VCT) -----------------
        if (VCT_active) {
            Flag_key  <- 4
            indx_todo <- which(have_glb)
            if (length(indx_todo) > 0) {
                ## start with old clear as 99
                subday$CSflag[subday$CSflag == 0] <- 99
                s_i <- data.table::shift(subday$wattGLB) - subday$wattGLB ##  /(t_i+i  - t_i)

                for (i in indx_todo) {
                    ## resolve window by index
                    walk(i, nt_hw , tot_p )

                    ## Do calculation ##
                    data_win_glb <- subday$wattGLB[w_sta:w_end]
                    DeltaVSq_GLB <- (data.table::shift(data_win_glb) - data_win_glb) ##  /(t_i+i  - t_i)
                    s_bar        <- sum(DeltaVSq_GLB, na.rm = T) / ( MS$nt - 1 )

                    GLB_sigma[i] <- sqrt( sum( (s_i[w_sta:w_end] - s_bar)**2 , na.rm = TRUE ) / ( MS$nt - 1 ) ) /
                                    sum( data_win_glb , na.rm = T) / MS$nt

                    ## pass test as clear
                    pass <- GLB_sigma[i] < MS$offVCT
                    if (is.na(pass)) { pass <- FALSE }

                    ## set VCT flag
                    subday$CSflag[w_sta:w_end][ ( ! subday$CSflag[w_sta:w_end] == 0)  &
                                                (   subday$CSflag[w_sta:w_end] == 99) &
                                                    pass                                ] <- 0
                } ##END for loop all points
            }
            #### if it is not clear is VCT
            ## set newer flag
            subday[[paste0("CSflag_", Flag_key)]][ subday$CSflag == 99 ] <- TRUE
            ## set old flag
            subday$CSflag[subday$CSflag == 99]                           <- Flag_key
        }


        #---- 5. Variability in the Shape of the irradiance Measurements (VSM) ----
        if (VSM_active) {
            Flag_key  <- 5
            indx_todo <- which(have_glb)
            if ( length(indx_todo) > 0 ) {
                ## start with old clear as 99
                subday$CSflag[subday$CSflag == 0] <- 99
                x_i_CS <- data.table::shift(CS_ref) - CS_ref

                for (i in indx_todo) {
                    ## resolve window by index
                    walk(i, nt_hw, tot_p)

                    ## change in measurements
                    data_win_glb  <- subday$wattGLB[w_sta:w_end]
                    DeltaVSq_GLB  <- (data.table::shift(data_win_glb) - data_win_glb)

                    ## change in reference
                    data_win_ref  <- subday$CS_ref[w_sta:w_end]
                    DeltaVSq_ref  <- (data.table::shift(data_win_ref) - data_win_ref)

                    suppressWarnings({
                        # GLB_Xi[i]      <- max(abs(DeltaVSq_GLB - x_i_CS[i]   ), na.rm = TRUE)
                        GLB_Xi[i] <- max(abs(DeltaVSq_GLB - DeltaVSq_ref), na.rm = TRUE)
                    })

                    ## pass test as clear
                    # pass      <- GLB_Xi[i]      < MS$offVSM
                    pass <- GLB_Xi[i] < MS$offVSM

                    if (is.na(pass)) pass <- FALSE

                    ## an info warning
                    if (is.infinite(GLB_Xi[i]) & i > 1) {
                        if (interactive()) print(paste(GLB_Xi[i], format(aday, "%F"), i, pass))
                    }

                    ## set VCT flag
                    subday$CSflag[w_sta:w_end][ ( !subday$CSflag[w_sta:w_end] == 0)  &
                                                (  subday$CSflag[w_sta:w_end] == 99) &
                                                   pass                                ] <- 0

                } ##END for loop all points
            }
            #### if it is not clear is VCT
            subday[[paste0("CSflag_", Flag_key)]][ subday$CSflag == 99 ] <- TRUE
            subday$CSflag[subday$CSflag == 99]                           <- Flag_key
        }


        #---- 6. Low Direct Irradiance limit (LDI) -----------------------------
        if (LDI_active) {
            Flag_key  <- 6
            ## low direct and not "Possible Direct Obstruction (23)"
            ## probably we know sun was obscured
            subday[CSflag == 0 &
                   wattHOR < MS$LDIlim &
                   QCF_DIR != "Possible Direct Obstruction (23)",
                   CSflag := Flag_key ]

            subday[CSflag == 99 &
                   wattHOR < MS$LDIlim &
                   QCF_DIR != "Possible Direct Obstruction (23)",
                   CSflag := Flag_key ]

            subday[wattHOR < MS$LDIlim &
                   QCF_DIR != "Possible Direct Obstruction (23)",
                   paste0("CSflag_", Flag_key) := TRUE ]

            subday[wattHOR < MS$LDIlim &
                   QCF_DIR != "Possible Direct Obstruction (23)",
                   paste0("CSflag_", Flag_key) := TRUE ]
        }


        #---- 7. Low Global Irradiance limit (LGI) -----------------------------
        if (LGI_active) {
            Flag_key  <- 7
            subday[ (CSflag == 0 ) & (wattGLB < MS$VGIlim), CSflag := Flag_key ]
            subday[ (CSflag == 99) & (wattGLB < MS$VGIlim), CSflag := Flag_key ]

            subday[ wattGLB < MS$VGIlim, paste0("CSflag_", Flag_key) := TRUE ]
            subday[ wattGLB < MS$VGIlim, paste0("CSflag_", Flag_key) := TRUE ]
        }



        #---- 11. Too low direct radiation (DsT) -----------------````----------
        if (DST_active & any(have_dir)) {
            Flag_key  <- 11
            subday[(CSflag == 0 ) & (wattHOR < CS_ref_HOR * ( 1 - (MS$DIR_s_T_fact / 100))),
                   CSflag := Flag_key]
            subday[(CSflag == 99) & (wattHOR < CS_ref_HOR * ( 1 - (MS$DIR_s_T_fact / 100))),
                   CSflag := Flag_key]

            subday[wattHOR < CS_ref_HOR * ( 1 - (MS$DIR_s_T_fact / 100)), paste0("CSflag_", Flag_key) := TRUE ]
        }




        #---- 8. Too Few CS point for the day (FCS) ----------------------------
        if (FCS_active) {
            Flag_key  <- 8
            ## check all other CS flags to set this
            wecare <- grep("CSflag_", names(subday), value = T)
            acount <- nrow(subday[ rowSums( subday[, ..wecare], na.rm = T) == 0, ])
            if ( acount < FCSlim ) {
                subday[ subday$CSflag == 0 , CSflag := Flag_key]
                subday[ subday$CSflag == 99, CSflag := Flag_key]
                subday[, paste0("CSflag_", Flag_key) := TRUE]
            }
        }



        ## keep Clear Sky detection
        strong$CSflag[sell]   <- subday$CSflag

        subday$CS_ref <- CS_ref

        gather <- rbind(gather, subday, fill = TRUE)

        strong$CS_ref[sell]   <- CS_ref

        keepday <- data.frame( Date       = aday,
                               RMSE       = RMSE_r,
                               MBE        = MBE,
                               cost       = cost,
                               MeanVIPcnt = MeanVIPcnt,
                               MaxVIPcnt  = MaxVIPcnt,
                               VILcnt     = VILcnt,
                               VCTcnt     = VCTcnt,
                               VSMcnt     = VSMcnt)

        # daily_stats <<- rbind(daily_stats, keepday )
        daily_stats <- rbind(daily_stats, keepday )

    } ##END day loop

    dev.off()


} ##END year loop


par(def.par)  # reset to default
layout(matrix(c(1), nrow = 1, ncol = 1, byrow = TRUE))
`````


| CS Flag | Test |
|:-------:|:--------------------------------------------------------------|
|   NA    | Undefined, untested                                           |
|    0    | Passed as clear sky                                           |
|    1    | Mean value of irradiance during the time period (MeanVIP)     |
|    2    | Max Value of Irradiance during the time Period (MaxVIP)       |
|    3    | Variability in irradiance by the length (VIL)                 |
|    4    | Variance of Changes in the Time series (VCT)                  |
|    5    | Variability in the Shape of the irradiance Measurements (VSM) |
|    6    | Low Direct Irradiance limit (LDI)                             |
|    7    | Low Global Irradiance limit (LGI)                             |
|    8    | Too Few CS point for the day (FCS)                            |
|    9    | Too Few data points for the day                               |
|   10    | Missing Data                                                  |
|   11    | Direct irradiance simple threshold                            |










### Cost function for optimization of alpha value.

$$ f(a) = \dfrac{ \sum_{i=1}^{n} ( a \cdot {GHI}_i - {CSI}_i )^2 }
                { n } , \qquad a > 0 $$





**END**

